<?xml version="1.0" encoding="UTF-8"?>
<root>

    <!-- 全局变量 -->
    <Variables>
        <Var id="trans_rate" type="short" default="1" desc="回传速率(Hz)" />
        <Var id="comm_rate" type="short" default="1" desc="波特率(bps)" />
    </Variables>

    <!-- 全局指令 -->
    <Commands>
    </Commands>
    
    <!-- 全局函数 -->
    <Functions>
        <Function id="read_param_func" desc="读取维特协议参数">
            <![CDATA[
                Plugins.WitNormal.ReadReg(new List<WitNormalRegMapping>
                {
                    new WitNormalRegMapping(){ Reg = 0x03, Var = "trans_rate" },
                    new WitNormalRegMapping(){ Reg = 0x04, Var = "comm_rate" },
                });
            ]]>
        </Function>

        <Function id="set_trans_rate_func" desc="设置回传速率">
            <![CDATA[
                var trans_rate = Variables.Get("trans_rate");

                Device.SendRef("unlock_reg");
                Device.SendHex("FF AA 03 " + trans_rate.ToHex(false), 100);
                Device.SendRef("save_reg");
            ]]>
        </Function>

        <Function id="set_comm_rate_func" desc="设置波特率">
            <![CDATA[
                var comm_rate = Variables.Get("comm_rate");

                Device.SendRef("unlock_reg");
                Device.SendHex("FF AA 04 " + comm_rate.ToHex(false), 100);
                Device.SendRef("save_reg");

                Thread.Sleep(50);
                int baudrate = ((short)comm_rate.Value) switch
                {
                    1 => 4800,
                    2 => 9600,
                    3 => 19200,
                    4 => 38400,
                    5 => 57600,
                    6 => 115200,
                    7 => 230400,
                    _ => 9600,
                };
				
				Device.ChangeBaudrate(baudrate);
            ]]>
        </Function>

        <Function id="set_z_axis_reset_func" desc="Z轴角度置零">
            <![CDATA[
                Device.SendHex("FF AA 01 04 00", 100);
            ]]>
        </Function>

         <Function id="set_gyrocaltime_func" desc="陀螺仪自动校准">
            <![CDATA[
                Device.SendHex("FF AA 63 F4 01", 100);
            ]]>
        </Function>
    </Functions>

    <!-- 控件配置 -->
    <UITemplate on-read-param="read_param_func">

        <!-- 子控件 -->
        <Controls desc="控件配置">
             <CAccordionGroup id="comm_configuration" text-zh="通讯" text-en="Communication">
                <Controls>
                    <!-- 通讯速率 -->
                    <CLable text-zh="通讯速率" text-en="Communication Rate"></CLable>
                    <CDropdown variable="comm_rate" onchange="set_comm_rate_func">
                        <Items>
                            <Item value="1" text-zh="4800" text-en="4800"></Item>
                            <Item value="2" text-zh="9600" text-en="9600"></Item>
                            <Item value="3" text-zh="19200" text-en="19200"></Item>
                            <Item value="4" text-zh="38400" text-en="38400"></Item>
                            <Item value="5" text-zh="57600" text-en="57600"></Item>
                            <Item value="6" text-zh="115200" text-en="115200"></Item>
                            <Item value="7" text-zh="230400" text-en="230400"></Item>
                        </Items>
                    </CDropdown>

                    <!-- 回传速率 -->
                    <CLable text-zh="回传速率" text-en="Transmission Rate"></CLable>
                    <CDropdown variable="trans_rate" onchange="set_trans_rate_func">
                        <Items>
                            <Item value="1" text-zh="0.2Hz" text-en="0.2Hz"></Item>
                            <Item value="2" text-zh="0.5Hz" text-en="0.5Hz"></Item>
                            <Item value="3" text-zh="1Hz" text-en="1Hz"></Item>
                            <Item value="4" text-zh="2Hz" text-en="2Hz"></Item>
                            <Item value="5" text-zh="5Hz" text-en="5Hz"></Item>
                            <Item value="6" text-zh="10Hz" text-en="10Hz"></Item>
                            <Item value="7" text-zh="20Hz" text-en="20Hz"></Item>
                            <Item value="8" text-zh="50Hz" text-en="50Hz"></Item>
                            <Item value="9" text-zh="100Hz" text-en="100Hz"></Item>
                            <Item value="11" text-zh="200Hz" text-en="200Hz"></Item>
                            <Item value="12" text-zh="500Hz" text-en="500Hz"></Item>
                            <Item value="13" text-zh="1000Hz" text-en="1000Hz"></Item>
                        </Items>
                    </CDropdown>
                </Controls>
            </CAccordionGroup>

            <CAccordionGroup id="calibration_configuration" text-zh="校准配置"
                text-en="Calibration Configuration">
                <Controls>
                    <CButton text-zh="Z轴角度置零" text-en="Z-axis Reset" onclick="set_z_axis_reset_func"/> 
                    <CButton text-zh="陀螺仪自动校准" text-en="gyrocaltime" onclick="set_gyrocaltime_func"/>
                </Controls>
            </CAccordionGroup>
        </Controls>
    </UITemplate>
</root>