<?xml version="1.0" encoding="UTF-8"?>
<root>

    <!-- 全局变量 -->
    <Variables>
        <Var id="comm_rate" type="short" default="1" desc="波特率(bps)" />
    </Variables>

    <!-- 全局指令 -->
    <Commands>
        <Cmd id="unlock_reg" desc="解锁寄存器" exp="FF AA 69 88 B5" is-hex="true" delay="100"/>
        <Cmd id="save_reg" desc="保存配置" exp="FF AA 00 00 00" is-hex="true" delay="100"/>
    </Commands>
    
    <!-- 全局函数 -->
    <Functions>
        <Function id="read_param_func" desc="读取维特协议参数">
            <![CDATA[
                Plugins.WitNormal.ReadReg(new List<WitNormalRegMapping>
                {
                    new WitNormalRegMapping(){ Reg = 0x04, Var = "comm_rate" }
                });
            ]]>
        </Function>

        <Function id="set_comm_rate_func" desc="设置波特率">
            <![CDATA[
                var comm_rate = Variables.Get<ShortVar>("comm_rate");

                Device.SendRef("unlock_reg");
                Device.SendHex("FF AA 04 " + comm_rate.ToHex(false), 100);
                Device.SendRef("save_reg");
            ]]>
        </Function>
        
    </Functions>

    <!-- 控件配置 -->
    <UITemplate on-read-param="read_param_func">
        <!-- 子控件 -->
        <Controls desc="控件配置">
            <CAccordionGroup id="comm_configuration" text-zh="通讯" text-en="Communication">
                <Controls>
                    <!-- 通讯速率 -->
                    <CLable text-zh="通讯速率" text-en="Communication Rate"></CLable>
                    <CDropdown variable="comm_rate" onchange="set_comm_rate_func">
                        <Items>
                            <Item value="1" text-zh="4800" text-en="4800"></Item>
                            <Item value="2" text-zh="9600" text-en="9600"></Item>
                            <Item value="3" text-zh="19200" text-en="19200"></Item>
                            <Item value="4" text-zh="38400" text-en="38400"></Item>
                            <Item value="5" text-zh="57600" text-en="57600"></Item>
                            <Item value="6" text-zh="115200" text-en="115200"></Item>
                            <Item value="7" text-zh="230400" text-en="230400"></Item>
                            <Item value="8" text-zh="460800" text-en="460800"></Item>
                            <Item value="9" text-zh="921600" text-en="921600"></Item>
                        </Items>
                    </CDropdown>
                </Controls>
            </CAccordionGroup>
        </Controls>
    </UITemplate>

    <!--全局数据解析器-->
    <GlabalParsers>
        <StreamParser id="stream_parser">
            <IsHex desc="是否为16进制">true</IsHex>
            <Content>
                <PackHeader desc="包头匹配" length="2">55 5F</PackHeader>
                <VariableMatch desc="变量匹配" length="2" var="trans_rate" convertTo="short" />
                <VariableMatch desc="变量匹配" length="2" var="comm_rate" convertTo="short" />
                <EmptyMatch desc="空值匹配" length="5" />
            </Content>
            <PackCheck>
                <Sum inputIndex="11" startIndex="0" endIndex="10"></Sum>
            </PackCheck>
        </StreamParser>
    </GlabalParsers>
</root>